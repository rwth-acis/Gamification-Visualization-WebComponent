<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/paper-toast/paper-toast.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/iron-signals/iron-signals.html">

<dom-module id="gamification-action-trigger">
    <template>
        <style>
            paper-toast {
                z-index: 1000;
            }
        </style>

        <!-- displays triggered action notification -->
        <paper-toast id="notification" duration="0" text="This toast will stay opened until you close it, or open another toast.">
            <paper-button on-click="openVisualization">Show Gamification</paper-button>
            <paper-button on-click="closeNotification">Close</paper-button>
        </paper-toast>

        <!-- Receive Events from any web component anywhere in the page using iron-signals -->
        <iron-signals on-iron-signal-gamification="processActionTringgerEvent"></iron-signals>
    </template>
    <script>
        Polymer({
            is: 'gamification-action-trigger',

            properties: {
                // The URL-Endpoint of the Gamification-Framework
                backendurl: {
                    type: String
                },

                // the id of the game to visualize
                gameid:  {
                    type: String
                },

                // the username of the current user to use for the api calls
                memberid: {
                    type: String
                },

                // The key of the access-token field in the local Storage
                accesstokenkeyname: {
                    type: String
                }
            },

            // entry point when an action is triggered and the
            processActionTringgerEvent: function (e) {
                if(this.memberid != "anonymous")
                {
                    let action = e.detail;

                    // only allow one login action - prevent constantly logging in and of for getting points
                    if(action == "login") {
                        if(this._hasLoggedInBefore) {
                            return;
                        }
                        this._hasLoggedInBefore = true;
                    }

                    // Trigger action and show notifications
                    var self = this;
                    this.triggerAction(action, function (notificationResponse) {
                        if (notificationResponse != undefined) //there are notifications to show
                        {
                            let notificationMessage = "";

                            for (let i = 0; i < notificationResponse.length; i++) {
                                notificationMessage = notificationMessage + " " + notificationResponse[i].message;
                            }

                            self.$.notification.text = notificationMessage;
                            self.$.notification.open();
                        }

                        // Fire signal to reload visualization when action is triggered
                        self.fire('iron-signal', {name: 'action-triggered', data: action});
                    }, function () {
                        alert("Error triggering action");
                    });
                }
            },

            // triggers an action for the current user. If the operation was successful it calls the successCallback and passes the notification to show as parameter or undefined if there aren't any.
            triggerAction: function(actionId, successCallback, errorCallback)
            {
                var accessToken = localStorage.getItem(this.accesstokenkeyname);
                var request = new XMLHttpRequest();
                request.open("POST", this.backendurl + "visualization/actions/" + this.gameid + "/" + actionId + "/" + this.memberid);
                request.setRequestHeader("access_token", accessToken);
                request.addEventListener('load', function(event) {
                    if (request.status >= 200 && request.status < 300)
                    {
                        var json = JSON.parse(request.responseText);
                        if(json.ok)
                        {
                            successCallback(json.notification);
                        }
                        else
                        {
                            errorCallback();
                        }
                    }
                    else
                    {
                        errorCallback();
                    }
                });
                request.send("");
            },

            // close the notification
            closeNotification(){
                this.$.notification.toggle();
            },

            // show the gamification visualization
            openVisualization: function () {
                location.href = '/users/me';
            }
        });
    </script>
</dom-module>